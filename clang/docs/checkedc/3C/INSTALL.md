# Building 3C

This document describes our current setup and build process for 3C.  You may find helpful information about topics not addressed here in the [general Checked C build documentation](../Setup-and-Build.md).  Some items here are potentially applicable to Checked C as a whole, and we hope to eventually harmonize them with the Checked C documentation as appropriate.

## Supported environments

We work primarily on Linux.  Checked C supports Windows, but we do not test 3C regularly on Windows.  Some of us use Mac OS X, which Checked C does not officially support; we have gotten 3C to mostly work with some additional steps (see below), but there are some known problems and [Microsoft is still considering whether to work with us to address them](https://github.com/microsoft/checkedc/issues/424#issuecomment-720648442).

## Basics

Assuming you have already cloned the `checkedc-clang` repository, run the following (from the root of the working tree) for a basic build:

```
(cd llvm/projects/checkedc-wrapper && git clone https://github.com/microsoft/checkedc)

mkdir build && cd build
cmake ../llvm -G Ninja -DLLVM_ENABLE_PROJECTS=clang
ninja TARGET
```

where TARGET stands for the target(s) you want to build.  For the `3c` command-line tool, the target is `3c`, but assuming you want to actually compile the Checked C source files generated by 3C, you'll also want to build `clang` (the Checked C compiler, which is a modified version of Clang).  Executables will end up in `build/bin`; you'll likely want to add this directory to your `$PATH`.

## Build options

Because all of LLVM and clang are built as dependencies, this may consume up to ~50 GB of disk space, take several hours (depending on the speed of your computer), and require ~10 GB of RAM.  Incremental builds will usually be faster.  Here are some things you can do that may reduce the build time and/or peak memory use:

- The above instructions already assume the use of the [Ninja](https://ninja-build.org/) build tool; you may have to install it.  You can alternatively use `make` (remove `-G Ninja` from the `cmake` command and replace `ninja` with `make`), but Ninja is much faster in our experience.
- Pass `-DLLVM_TARGETS_TO_BUILD=X86` (or whatever your machineâ€™s architecture is, e.g., `ARM`) to `cmake` to build only the parts of `clang` needed to compile programs for your machine.
- Pass `-DLLVM_USE_LINKER=lld`.  This requires a sufficiently recent version of `lld` to be installed on your system.
- Pass `-DLLVM_USE_SPLIT_DWARF=ON`.  We have tested the build with this option, but it may affect some debugging tools.
- Pass `-DLLVM_OPTIMIZED_TABLEGEN=ON`.

(The reference for improving build performance is [this LLVM page](https://www.llvm.org/docs/GettingStarted.html#common-problems), but we have attempted to describe the most promising options here.)

You might want to use `-DCMAKE_BUILD_TYPE=RelWithDebInfo` if you are running 3C enough between builds that the faster running time outweighs the slower build time or you simply want to test a release build of 3C, assuming that's what end users will eventually be encouraged to use.

## Mac OS X

On some OS X versions, you have to add `-DDEFAULT_SYSROOT=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk` to the `cmake` command; add it just after the `-DLLVM_ENABLE...` flags. You also need to make sure that the XCode developer command-line tools are installed, per [this thread](https://github.com/Homebrew/homebrew-core/issues/20791). Go to https://developer.apple.com/download/more/, log in with your Apple Developer ID, and download "Command Line Tools for Xcode 11.3.1". Then, enable these by invoking (from the command line), `sudo xcode-select -r`.

## CR/LF issues

There is a [known problem](https://github.com/correctcomputation/checkedc-clang/issues/317) where git shows source files in a clean checkout as having modified line endings, even if you only ever use Linux.  The problem seems to occur less often with newer versions of git.  We believe the root cause is that [the root `.gitattributes` file](../../../.gitattributes) inaccurately states that all files have LF endings, but some have CRLF endings in the repository; we will try to fix that when we can.  In the meantime, running the following commands in a working tree that is experiencing the problem seems to make it go away, at least temporarily:

```
git rm .gitattributes
git status
git checkout HEAD -- .gitattributes
```
